# AGENTS.md — Magic Prison Roguelike (для Codex / агентов)

Этот документ — единственный «источник истины» по идее проекта, требованиям и правилам реализации.
**Дорожная карта (Roadmap) обязана обновляться после выполнения каждой задачи**: отмечай выполненное, добавляй новые подзадачи, фиксируй изменения дизайна.

---

## 1) Коротко об игре

**Magic Prison** — карточный рогалик в мрачной ироничной магической тюрьме.
Цель забега: **пройти 10 этажей** (с боссом в конце) через **3 акта**, собирая колоду и собирая билды.
После победы можно продолжать **в бесконечную «петлю»** (эндлесс), где враги усиливаются.

Визуальный стиль: **псевдо‑пиксельный Slay the Spire**, минималистичные анимации, без звука.

---

## 2) Платформа и ограничения

- Запуск: **Python (Flask) + браузер** через `localhost`.
- Структура: **до 7–10 файлов** (включая фронт/бек и данные).
- Без внешних тяжёлых библиотек (кроме Flask).
- Автосейв: состояние сохраняется на диск (`./saves/<sid>.json`) и продолжает жить после перезагрузки страницы.

---

## 3) Экраны и UX (обязательно)

Должны существовать экраны (как минимум):
1) Главное меню  
2) Настройки  
3) Энциклопедия карт (кодекс)  
4) Экран колоды  
5) Карта пути / выбор комнаты  
6) Экран боя  
7) Экран награды  
8) Победа  
9) Поражение  

UX:
- **Мышь**: перетаскивание карт по полю и на цель.
- **Клавиатура**: `Space` — конец хода, `Esc` — меню (опционально).
- Анимации: минимальные (hover, pulse, подсветка целей).

---

## 4) Основной цикл (Run Loop)

### Этажи и акты
- Всего **10 этажей**.
- **3 акта**. Боссы на этажах: **4 / 8 / 10**.
- На каждом этаже: бой/ивент/лавка/костёр/награда — зависит от выбранного пути.

### Выбор пути
- На каждом шаге игрок выбирает **один из нескольких путей/комнат**.
- Рандом, но разумные веса (не превращать всё в бои подряд).

---

## 5) Бой (обязательно)

### Сетап
- Игрок **1** против **1–3 врагов**.
- В конце этапа/акта — **босс**.

### Мана / рука / колода
- Есть **мана** (энергия).
- Рука: максимум **6 карт**.
- Неразыгранные карты **сбрасываются в конце хода**.
- Когда колода заканчивается — **тасуется сброс**.

### Телеграф
- Враги показывают **намерение (intent)** на следующий ход.

### Криты
- Все атаки игрока критуют с шансом **15%** (базово). Можно бафами менять.

### Типы карт
- **Attack** (атака)
- **Defense** (защита)
- **Skill** (навык/утилити)
- **Upgrade** (апгрейд‑карта):  
  - при розыгрыше **исчезает из колоды до конца боя** (exhaust)  
  - даёт **баф на время боя**

### Механики билдов (обязательно)
Нужно поддержать минимум **12 потенциальных билд‑направлений** (через теги/эффекты):
- Заряд (карта остаётся в руке и усиливается)
- DoT: яд / ожог / кровоток
- Контроль: оглушение / заморозка / ослабления
- Взрыв/бурст (AOE/детонации)
- Билд от сброса (discard‑синергии)
- Блок/броня
- Мана/ускорение
- Крит/мультипликаторы
- Изгнание (exhaust‑синергии)
- Добор/цикл колоды
- Execute / добивание
- Дебаф‑стеккинг

---

## 6) Карты, редкости и прогрессия

### Редкости и пул
- 4 редкости:
  - common: **20**
  - uncommon: **15**
  - rare: **10**
  - legendary: **5**
- Итого: **50 карт**.
- Начальная колода: **10 карт**.
- Классов **нет**: колода строится по ходу игры из общего пула.

### Награды
- После боя выдаётся награда:
  - золото/жетоны
  - выбор **1 карты** из 3 (можно пропустить)

### Костёр
- Ровно 2 опции:
  - отдых (хил)
  - улучшить карту

### Конец акта (после босса)
- Игрок обязан:
  1) **продублировать** 1 карту (выбор из 4 случайных)
  2) **удалить** 1 карту (выбор из 4 случайных)
- Пока оба не сделаны — акт не продолжается.

### Мета-наследие
- Между забегами: можно оставить **3 старые карты** на новый забег.
- Для каждого из 3 слотов — **выбор из 5 случайных** (из прошлой колоды).

---

## 7) Тон и нарратив

- Атмосфера: **мрак + ирония**.
- Тюрьма «подшучивает» над игроком текстами событий, описаниями врагов, репликами лавочника.
- Без звука.

---

## 8) Технические требования (важно)

### Сервер/клиент
- Сервер (Python) хранит стейт и применяет правила.
- Клиент (JS) только отображает и отправляет действия.

### Действия (Action API)
Клиент отправляет:
- `NEW_RUN`
- `CONTINUE` (переход к правильному экрану, если забег жив)
- `CHOOSE_ROOM`
- `PLAY_CARD`
- `END_TURN`
- `PICK_REWARD`
- `EVENT_OPT`, `EVENT_PICK`
- `SHOP_BUY`, `SHOP_LEAVE`, `SHOP_REMOVE`
- `CAMPFIRE`, `CAMPFIRE_UP`
- `ACT_END`
- `INHERIT_PICK`
- `SET_DIFFICULTY`
- `CONTINUE_ENDLESS`
- `RESOLVE_PENDING` (подвыборы внутри боя)

### Сериализация и сейвы (критично!)
- В save‑файл нельзя писать несериализуемые объекты (например `random.Random`).
- Запись сейва должна быть **атомарной**:
  - писать во временный файл и делать `os.replace()`
  - иначе при падении сервера/перезапуске возможны битые JSON

### Детерминизм
- RNG должен вычисляться из seed и быть воспроизводимым, но **не храниться** объектом в JSON.
- Для боя и генерации контента хранить только seed/счётчики.

---

## 9) Текущие известные проблемы (BUGS)

Список обязан обновляться и очищаться по мере фикса.

### BUG-01: В бою «не срабатывают» карты и не обновляется мана — **ИСПРАВЛЕНО**
Результат: убраны несериализуемые временные поля (`_rng`) перед сохранением, так что действия карты сохраняются и состояние боя возвращается на фронт.

Критичность: **Blocker** (устранён)

---

### BUG-02: Энциклопедия (кодекс) «разъезжается» и выходит за края экрана — **ИСПРАВЛЕНО**
Результат: панели оверлеев ограничены по высоте и получили прокрутку, сетка кодекса стала адаптивной через `auto-fit` и минимальные ширины колонок.

Критичность: **Major** (устранён)

---

### BUG-03: После перезагрузки страницы теряется прогресс / невозможно продолжить, сейв бьётся — **ИСПРАВЛЕНО**
Результат: запись сейва стала атомарной, битые JSON переименовываются в `.corrupt`, а фронт/сервер возвращают игрока в актуальный экран через действие `CONTINUE`.

Критичность: **Blocker** (устранён)

---

### BUG-04: «Получение новых карт» должно быть гарантировано
Симптомы:
- игрок не получает карты/награды (или награда не открывается)

Ожидаемая проверка:
- после каждого боя обязательно формировать reward state
- убедиться, что `PICK_REWARD` корректно добавляет карту и переводит обратно на MAP

Критичность: **Major**

---

## 10) Дорожная карта (Roadmap)

**ВНИМАНИЕ:** обновляй этот раздел после каждой задачи (галочки, дата, что изменилось).

### Этап A — Стабилизация (Blockers)
- [x] A1. Починить сейвы:
  - атомарная запись + восстановление после битого JSON (rename `.corrupt`)
- [x] A2. Починить бой:
  - карты должны применяться к цели
  - мана в HUD/панели игрока должна отображаться всегда
- [x] A3. Починить продолжение после refresh:
  - действие `CONTINUE` вызывается после bootstrap если есть активный run
  - корректное возвращение на COMBAT/REWARD/MAP и т.д.
- [x] A4. Стэкинг бафов апгрейдов и корректное срабатывание повторных усилений (2025-05-17)

### Этап B — UI/UX
- [x] B1. Исправить кодекс (overflow + responsive grid)
- [x] B2. Улучшить визуал дропа: подсветка цели, запрет розыгрыша при нехватке маны (2025-05-14)
- [x] B3. Экран колоды: сортировка/фильтр по редкости/типу/тегам (2025-05-14)
- [x] B4. Стабилизировать макеты: закрепить полосу прокрутки и сделать адаптивные сетки наград/удаления после босса (2025-05-13)
- [x] B5. Карта: масштабирование/прокрутка и увеличенные интервалы, чтобы подсказки узлов не накладывались (2025-05-21)
- [x] B6. Центрировать оверлеи и скрыть светлые полосы прокрутки на модалках (2025-05-15)


### Этап C — Контент и билдостроение
- [ ] C1. Довести пул карт до стабильного баланса (особенно legendary)
- [ ] C2. Увеличить разнообразие событий (ирония/мрак)
- [ ] C3. Расширить пул врагов и боссов, уникальные паттерны
  - [+] Добавлены новые обычные враги: манопиявка, стужный надзиратель, кровавый палач (2025-05-15)

### Этап D — «Настоящая» карта пути (как в StS)
- [x] D1. Генерация графа путей (несколько линий, связи) (2025-05-14)
- [x] D2. Визуализация линий/узлов на фронте (2025-05-14)

### Этап E — Мета и эндгейм
- [ ] E1. Реликвии/артефакты
- [ ] E2. Проклятья/нагрузка колоды
- [ ] E3. Эндлесс‑скейлинг (четкий рост сложности, награды, рекорды)

---

## 11) Стандарты для агента (Codex)

При изменениях:
- не менять фундаментальные правила боя без согласования (рука 6, сброс в конце хода, крит 15%, upgrade‑exhaust‑buff)
- делать изменения так, чтобы продолжали работать сейвы (или повышать `SAVE_VERSION` и миграцию)

При коммитах/правках:
- всегда запускать короткий smoke‑тест:
  - новый забег
  - выбрать комнату
  - сыграть карту на врага
  - закончить ход
  - получить награду и взять карту
  - обновить страницу и продолжить

---

Подпись: **Этот Roadmap нужно обновлять при выполнении каждой задачи.**